// Generated by CoffeeScript 1.6.3
(function() {
  var Smackbone, root, _, _ref,
    __slice = [].slice,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  if (typeof exports !== "undefined" && exports !== null) {
    Smackbone = exports;
    _ = require('underscore');
    Smackbone.$ = {
      done: function(func) {
        return func();
      },
      ajax: function(options) {
        return this;
      }
    };
  } else {
    root = this;
    _ = root._;
    Smackbone = root.Smackbone = {};
    Smackbone.$ = root.$;
  }

  Smackbone.Event = (function() {
    function Event() {}

    Event.prototype.trigger = function() {
      var allEvents, args, events, name, _ref, _ref1;
      name = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      events = (_ref = this._events) != null ? _ref[name] : void 0;
      if (events != null) {
        this._triggerEvents.apply(this, [events].concat(__slice.call(args)));
      }
      allEvents = (_ref1 = this._events) != null ? _ref1.all : void 0;
      if (allEvents != null) {
        this._triggerEvents.apply(this, [allEvents, name].concat(__slice.call(args)));
      }
      return this;
    };

    Event.prototype.on = function(name, callback) {
      var events;
      if (this._events == null) {
        this._events = {};
      }
      if (!_.isFunction(callback)) {
        throw new Error('Must have a valid function callback');
      }
      if (/\s/g.test(name)) {
        throw new Error('Illegal event name');
      }
      events = this._events[name] || (this._events[name] = []);
      events.push({
        callback: callback,
        self: this
      });
      return this;
    };

    Event.prototype.off = function(name, callback) {
      var event, events, key, names, newEvents, _i, _j, _len, _len1;
      if (callback == null) {
        this._events = {};
        return this;
      }
      events = this._events[name];
      names = name ? [name] : (function() {
        var _i, _len, _ref, _results;
        _ref = this._events;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          key = _ref[_i];
          _results.push(key);
        }
        return _results;
      }).call(this);
      for (_i = 0, _len = names.length; _i < _len; _i++) {
        name = names[_i];
        newEvents = [];
        this._events[name] = newEvents;
        for (_j = 0, _len1 = events.length; _j < _len1; _j++) {
          event = events[_j];
          if (callback !== event.callback) {
            newEvents.push(event);
          }
        }
        if (newEvents.length === 0) {
          delete this._events[name];
        }
      }
      return this;
    };

    Event.prototype._triggerEvents = function() {
      var args, event, events, _i, _len, _results;
      events = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      _results = [];
      for (_i = 0, _len = events.length; _i < _len; _i++) {
        event = events[_i];
        _results.push(event.callback.apply(event, args));
      }
      return _results;
    };

    return Event;

  })();

  Smackbone.Model = (function(_super) {
    __extends(Model, _super);

    function Model(attributes, options) {
      var properties;
      this._properties = {};
      this.cid = _.uniqueId('m');
      properties = attributes != null ? attributes : {};
      this.set(properties);
      if (typeof this.initialize === "function") {
        this.initialize(properties);
      }
    }

    Model.prototype.toJSON = function() {
      return _.clone(this._properties);
    };

    Model.prototype.isNew = function() {
      return this.id == null;
    };

    Model.prototype.clone = function() {
      return new this.constructor(this._properties);
    };

    Model.prototype.set = function(key, value) {
      var attributes, changeName, changedPropertyNames, current, idAttribute, isChanged, modelClass, name, options, previous, _i, _len, _ref, _ref1;
      if (key == null) {
        return;
      }
      idAttribute = 'id';
      if (typeof key === 'object') {
        attributes = key;
        options = value;
      } else {
        (attributes = {})[key] = value;
      }
      this._previousProperties = _.clone(this._properties);
      current = this._properties;
      previous = this._previousProperties;
      changedPropertyNames = [];
      this.changed = {};
      for (name in attributes) {
        value = attributes[name];
        if (name === idAttribute) {
          this[idAttribute] = value;
        }
        if (current[name] !== value) {
          changedPropertyNames.push(name);
        }
        if (previous[name] !== value) {
          this.changed[name] = value;
        }
        if (((_ref = current[name]) != null ? _ref.set : void 0) != null) {
          current[name].set(value);
        } else {
          if (current[name] == null) {
            modelClass = (_ref1 = this.models) != null ? _ref1[name] : void 0;
            if ((modelClass == null) && _.isArray(value)) {
              modelClass = Smackbone.Collection;
            }
            if (modelClass != null) {
              value = new modelClass(value);
            }
          }
          if (value instanceof Smackbone.Model) {
            if (value._parent == null) {
              value._parent = this;
              value.id = name;
              this[name] = value;
            }
          }
          current[name] = value;
          this.length = _.keys(current).length;
        }
      }
      for (_i = 0, _len = changedPropertyNames.length; _i < _len; _i++) {
        changeName = changedPropertyNames[_i];
        this.trigger("change:" + changeName, this, current[changeName]);
      }
      isChanged = changedPropertyNames.length > 0;
      if (isChanged) {
        this.trigger('change', this);
      }
      return value;
    };

    Model.prototype.get = function(key) {
      return this._properties[key];
    };

    Model.prototype.unset = function(key) {
      var model;
      model = this._properties[key];
      delete this._properties[key];
      if (model != null) {
        if (typeof model.trigger === "function") {
          model.trigger('unset', model);
        }
      }
      return model != null ? typeof model.trigger === "function" ? model.trigger('remove', model) : void 0 : void 0;
    };

    Model.prototype.path = function() {
      var prefix, _ref, _ref1;
      if (this._parent != null) {
        prefix = this._parent.path();
        return "" + prefix + "/" + ((_ref = this.id) != null ? _ref : '');
      } else {
        return (_ref1 = this.rootPath) != null ? _ref1 : '';
      }
    };

    Model.prototype._root = function() {
      var model;
      model = this;
      while (model._parent != null) {
        model = model._parent;
      }
      return model;
    };

    Model.prototype.fetch = function() {
      this._root().trigger('fetch_request', this.path(), this);
      return this.trigger('fetch', this);
    };

    Model.prototype.save = function() {
      this._root().trigger('save_request', this.path(), this);
      return this.trigger('save', this);
    };

    Model.prototype.destroy = function() {
      return this.trigger('destroy', this);
    };

    Model.prototype.each = function(func) {
      var object, x, _ref, _results;
      _ref = this._properties;
      _results = [];
      for (object in _ref) {
        x = _ref[object];
        _results.push(func(x));
      }
      return _results;
    };

    Model.prototype.reset = function() {
      var key, value, _ref, _results;
      _ref = this._properties;
      _results = [];
      for (key in _ref) {
        value = _ref[key];
        _results.push(this.unset(key));
      }
      return _results;
    };

    return Model;

  })(Smackbone.Event);

  Smackbone.Collection = (function(_super) {
    var idAttribute;

    __extends(Collection, _super);

    function Collection() {
      _ref = Collection.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    idAttribute = 'id';

    Collection.prototype.add = function(object) {
      return this.set(object);
    };

    Collection.prototype.get = function(object) {
      if (object.id != null) {
        return Collection.__super__.get.call(this, object.id);
      } else if (object.cid != null) {
        return Collection.__super__.get.call(this, object.cid);
      } else {
        return Collection.__super__.get.call(this, object);
      }
    };

    Collection.prototype.contains = function(key) {
      return this.get(key) != null;
    };

    Collection.prototype._toModel = function(object) {
      var klass, model, _ref1;
      if (object instanceof Smackbone.Model) {
        return object;
      } else {
        klass = (_ref1 = this.model) != null ? _ref1 : Smackbone.Model;
        model = new klass(object);
        model[idAttribute] = object.id;
        if (object.cid != null) {
          model.cid = object.cid;
        }
        return model;
      }
    };

    Collection.prototype.create = function(object) {
      var model;
      model = this._toModel(object);
      model._parent = this;
      this.set(model);
      model.save();
      return model;
    };

    Collection.prototype._isExistingModel = function(object) {
      var cid, existingModel, id;
      id = object[idAttribute];
      if (id != null) {
        existingModel = this.get(id);
      }
      if (existingModel == null) {
        cid = object['cid'];
        if (cid != null) {
          existingModel = this.get(cid);
        }
      }
      return existingModel != null;
    };

    Collection.prototype.set = function(objects) {
      var id, model, object, _i, _len, _results;
      if (_.isEmpty(objects)) {
        return;
      }
      objects = _.isArray(objects) ? objects : [objects];
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        object = objects[_i];
        if (!this._isExistingModel(object)) {
          model = this._toModel(object);
        } else {
          model = object;
        }
        model._parent = this;
        id = model[idAttribute];
        if (id != null) {
          _results.push(Collection.__super__.set.call(this, id, model));
        } else {
          if (model.cid == null) {
            throw "An object in a collection must have an id or cid attribute";
          }
          _results.push(Collection.__super__.set.call(this, model.cid, model));
        }
      }
      return _results;
    };

    Collection.prototype.remove = function(object) {
      if (object.id != null) {
        return this.unset(object.id);
      } else {
        return this.unset(object.cid);
      }
    };

    Collection.prototype.toJSON = function() {
      return _.toArray(Collection.__super__.toJSON.call(this));
    };

    return Collection;

  })(Smackbone.Model);

  Smackbone.Syncer = (function(_super) {
    __extends(Syncer, _super);

    function Syncer(options) {
      this._onSaveRequest = __bind(this._onSaveRequest, this);
      this._onFetchRequest = __bind(this._onFetchRequest, this);
      this.root = options.model;
      this.root.on('fetch_request', this._onFetchRequest);
      this.root.on('save_request', this._onSaveRequest);
    }

    Syncer.prototype._onFetchRequest = function(path) {
      var options,
        _this = this;
      options = {};
      options.type = 'GET';
      options.done = function(response) {
        var model;
        model = _this._findModel(path);
        return model.set(response);
      };
      return this._request(options, path);
    };

    Syncer.prototype._findModel = function(path) {
      var model, part, parts, _i, _len;
      parts = (path.split('/')).slice(1);
      model = this.root;
      for (_i = 0, _len = parts.length; _i < _len; _i++) {
        part = parts[_i];
        model = model.get(part);
      }
      return model;
    };

    Syncer.prototype._onSaveRequest = function(path, model) {
      var options,
        _this = this;
      options = {};
      options.type = model.isNew() ? 'POST' : 'PUT';
      options.data = JSON.stringify(model.toJSON());
      options.done = function(response) {
        return model.set(response);
      };
      return this._request(options, path);
    };

    Syncer.prototype._request = function(options, path) {
      var _ref1;
      options.url = ((_ref1 = this.urlRoot) != null ? _ref1 : '') + path;
      options.contentType = 'application/json';
      this.trigger('request', options);
      return Smackbone.$.ajax(options).done(options.done);
    };

    return Syncer;

  })(Smackbone.Event);

}).call(this);
